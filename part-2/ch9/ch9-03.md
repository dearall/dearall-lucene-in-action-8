## 9.3 控制结构 Control structures ##

结束了对属性设置、内容源、文档构造器、查询构造器的讨论，现在讨论算法脚本中的控制结构，它是一种非常重要的“粘合剂”，允许调用各种内置任务，并将多个任务有机组合起来。

下面是控制结构的构建块：

**■** 通过 { ... } 块创建顺序执行序列（Serial sequences）。包含在块中的任务，在同一个线程内，一个接着一个地运行，例如：

```perl
{ CreateIndex AddDoc CloseIndex }
```

上述构建块表示，创建一个新的索引，从 doc maker 获取一个文档添加到索引，然后关闭索引。

**■** 要在后台运行一个任务，在任务的后面添加 & 符号。例如：

```perl

OpenReader

{ Search > : * &
{ Search > : * &

Warit(30)
CloseReader

```

上面的构建块，打开一个 reader，在后台运行两个搜索线程，等待 30 秒，请求后台线程停止，并关闭 reader


**■** 通过 [ … ] 构建块创建并行运行序列（Parallel sequences）。一个并行运行序列通过与所包含任务数量相同数量的线程运行，每一个任务都运行在它自己的线程上。例如：

```perl
[AddDoc AddDoc AddDoc AddDoc]
```

这个构建块创建了 4 个线程，每个线程添加一个文档，然后停止。

**■** 多次重复执行一个任务，由在任务或者任务块结尾添加 :N 实现。例如：

```perl
{AddDoc}: 1000
```

一个接着一个地从文档源获取 1000 个文档（next 1000 documents）加入索引。使用星号 \* 从 doc maker 获取全部文档加入索引，称为耗尽重复（Exhaustive repeating）。例如：

```perl
{AddDoc}: *
```

这个构建块从 doc maker 获取全部文档添加到索引。在使用这样的构建块时，必须要将属性 content.source.forever 设置为 false 值，否则会出现无限往复循环的状况。


**■** 按指定数量的时间重复执行一个任务，可以在任务或块结尾处添加 :Xs 实现，例如：

```perl
{AddDoc}: 10.0s
```

该构建块运行 10 秒钟，10 秒之后停止。

**■** 给序列块命名，将名字 "name" 放在紧接着 '{' 或 '[' 之后即可，例如：

```perl
{"My Name" AddDoc} : 1000
```

这个构建块定义了一个 AddDoc 任务，名字为 "My Name"，并运行 1000 词。包围名字的双引号是必须的，即使名字中没有空格也是如此。这个名字将用在报告中。

**■** 有些任务可以带有可选的参数，在任务后面的圆括号 () 之内。例如，`AddDoc(1024)` 创建文档，它的 body 域由大约 1024 个字符组成（尽力不切分单词）。如果尝试给不需要参数的任务传递参数，或者类型不正确，会遇到 “Cannot understand algorithm” 错误。表 9.6 和 表 9.7 详细说明每个任务可接受的参数。


**■** 关闭子任务的统计信息要求使用 \> 字符替代块结束的 } 或者 ] 字符。这个功能用于在不需要某个任务级别详细信息时，避免收集统计信息的开销。例如：

```perl
{ "ManyAdds" AddDoc > : 10000
```

这个构建块向索引添加 10000 个文档，并且不单独跟踪每次调用 AddDoc 任务的统计信息。但是，这 10000 个加入索引的文档，由包含 "ManyAdds" 的外层序列跟踪。

**■** 速度 Rate：除了可以给任务或任务序列指定重复执行多少次，还能够给它们指定目标速度，单位是 “次数/秒（默认）” 或者 “次数/分钟”，通过在任务或序列结尾添加 : N : R 的形式。例如：

```perl
{ AddDoc } : 10000 : 100/sec
```

这个构建块表明，以每秒钟 100 个文档的速度，向索引添加 10000 个文档。或者：

```perl
[ AddDoc ]: 10000: 3
```

该构建块表明，并行向索引添加 10000 个文档，为每一个添加的文档启用一个线程，以每秒 3 个新线程的速度进行。

**■** 每个任务都会贡献自己的记录计数，用于在结束时做出报告。例如，AddDoc 任务返回 1。大多数的任务返回 1，有些返回 0 值，还有些任务返回大于 1 的计数值。有时候，不想要在最终的报告中包含某个任务的计数值。要这样做，简单地在任务之前添加一个连字符 (-) 即可。例如：

```perl
{"BuildIndex"
    -CreateIndex
    {AddDoc}:10000
    -CloseIndex
}
```

这个报告会记录正好 10000 个记录，但如果不适应 - 字符，它会报告 10002 个记录。








